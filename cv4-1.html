<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/wanadev/perspective.js/dist/perspective.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #FFFFFF;
        }

        canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
    const canvas = new fabric.Canvas('canvas', { selection: false });
    let overlayImg, controlPoints = [];

    function initializeCanvas() {
        canvas.setWidth(window.innerWidth - 20);
        canvas.setHeight(window.innerHeight - 20);

        // Load and add the overlay image
        fabric.Image.fromURL('https://raw.githubusercontent.com/DaveG925/centering/main/centering2.png', function (img) {
            overlayImg = img;
            overlayImg.set({
                left: canvas.getWidth() / 4,
                top: canvas.getHeight() / 4,
                scaleX: 0.5,
                scaleY: 0.5,
                hasControls: false,
                selectable: false
            });
            canvas.add(overlayImg);
            initializeControlPoints();
        });
    }

    function initializeControlPoints() {
        const positions = [
            { left: overlayImg.left, top: overlayImg.top },
            { left: overlayImg.left + overlayImg.getScaledWidth(), top: overlayImg.top },
            { left: overlayImg.left, top: overlayImg.top + overlayImg.getScaledHeight() },
            { left: overlayImg.left + overlayImg.getScaledWidth(), top: overlayImg.top + overlayImg.getScaledHeight() }
        ];

        positions.forEach(pos => {
            const circle = new fabric.Circle({
                radius: 5,
                fill: 'red',
                left: pos.left,
                top: pos.top,
                originX: 'center',
                originY: 'center',
                hasControls: false,
                hasBorders: false,
                selectable: true,
            });

            circle.on('moving', updateOverlayImagePosition);
            controlPoints.push(circle);
            canvas.add(circle);
        });
    }

    function updateOverlayImagePosition() {
        const srcCorners = [
            { x: 0, y: 0 },
            { x: overlayImg.width, y: 0 },
            { x: 0, y: overlayImg.height },
            { x: overlayImg.width, y: overlayImg.height }
        ];

        const destCorners = controlPoints.map(p => ({ x: p.left, y: p.top }));

        const transform = PerspT(
            srcCorners.flatMap(c => [c.x, c.y]),
            destCorners.flatMap(c => [c.x, c.y])
        );

        const matrix = transform.coeffs;
        overlayImg.set({
            left: 0,
            top: 0,
            transformMatrix: [
                matrix[0], matrix[1], 0,
                matrix[2], matrix[3], 0,
                matrix[4], matrix[5], 1
            ]
        });
        canvas.renderAll();
    }

    window.onload = initializeCanvas;
    window.onresize = initializeCanvas;
</script>
</body>
</html>
