<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective@1.1.3/dist/umd/perspective.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #FFFFFF;
        }

        canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
    const canvas = new fabric.Canvas('canvas', { selection: false });
    let overlayImg, controlPoints = [];

    function initializeCanvas() {
        canvas.setWidth(window.innerWidth - 20);
        canvas.setHeight(window.innerHeight - 20);

        // Load and add the overlay image
        fabric.Image.fromURL('https://raw.githubusercontent.com/DaveG925/centering/main/centering2.png', function (img) {
            overlayImg = img;
            overlayImg.set({
                left: canvas.getWidth() / 4,
                top: canvas.getHeight() / 4,
                scaleX: 0.5,
                scaleY: 0.5,
                hasControls: false,
                selectable: false
            });
            canvas.add(overlayImg);
            initializeControlPoints();
        });
    }

    function initializeControlPoints() {
        const positions = [
            { left: overlayImg.left, top: overlayImg.top },
            { left: overlayImg.left + overlayImg.getScaledWidth(), top: overlayImg.top },
            { left: overlayImg.left, top: overlayImg.top + overlayImg.getScaledHeight() },
            { left: overlayImg.left + overlayImg.getScaledWidth(), top: overlayImg.top + overlayImg.getScaledHeight() }
        ];

        positions.forEach(pos => {
            const circle = new fabric.Circle({
                radius: 5,
                fill: 'blue',
                left: pos.left,
                top: pos.top,
                originX: 'center',
                originY: 'center',
                hasControls: false,
                hasBorders: false,
                selectable: true,
            });

            circle.on('moving', updateOverlayImagePosition);
            controlPoints.push(circle);
            canvas.add(circle);
        });
    }

    function updateOverlayImagePosition() {
        const srcCorners = [
            [0, 0],
            [overlayImg.width, 0],
            [0, overlayImg.height],
            [overlayImg.width, overlayImg.height]
        ];

        const destCorners = controlPoints.map(p => [p.left, p.top]);

        const perspT = perspective.transform(destCorners, srcCorners);

        const matrix = [
            perspT[0][0], perspT[0][1], perspT[0][2],
            perspT[1][0], perspT[1][1], perspT[1][2],
            perspT[2][0], perspT[2][1], perspT[2][2]
        ];

        overlayImg.set({
            left: 0,
            top: 0,
            transformMatrix: matrix
        });

        canvas.renderAll();
    }

    window.onload = initializeCanvas;
    window.onresize = initializeCanvas;
</script>
</body>
</html>
